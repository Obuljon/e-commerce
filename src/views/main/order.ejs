
<div class="bg-light py-3">
    <div class="container">
      <div class="row">
        <div class="col-md-12 mb-0"><a href="/">Home</a> <span class="mx-2 mb-0">/</span> <a href="/pagecart">Cart</a> <span class="mx-2 mb-0">/</span> <strong class="text-black">Checkout</strong></div>
      </div>
    </div>
  </div>

  <div class="site-section">
    <div class="container">
      <form id="order">
      <div class="row">
        <div class="col-md-6 mb-5 mb-md-0">
          <h2 class="h3 mb-3 text-black">Billing Details</h2>
          <div class="p-3 p-lg-5 border">
            <div class="form-group row">
              <div class="col-md-6">
                <label for="c_fname" class="text-black">First Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="c_fname" name="fname">
              </div>
              <div class="col-md-6">
                <label for="c_lname" class="text-black">Last Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="c_lname" name="lname">
              </div>
            </div>

            <div class="form-group row">
              <div class="col-md-12">
                <label for="c_companyname" class="text-black">Company Name </label>
                <input type="text" class="form-control" id="companyname" name="companyname">
              </div>
            </div>

            <div class="form-group">
                <label for="country" class="text-black">qaysi viloyatga<span class="text-danger">*</span></label>
                <select id="region" class="form-control" name="region">
                    <option value="...">...</option>
                    <option value="Toshkent">toshkent</option>    
                    <option value="Xorazm">xorazm</option>    
                    <option value="Andijon">andijon</option>    
                    <option value="Namangan">namangan</option>    
                    <option value="Qo'qon">qo'qon</option>    
                    <option value="Sirdaryo">guliston</option>    
                    <option value="Jizzax">jizzah</option>    
                    <option value="Samarqand">samarqand</option>
                    <option value="Qashqadaryo">qarshi</option>     
                    <option value="Surxondaryo">termiz</option>
                    <option value="Buxoro">buhoro</option> 
                    <option value="Navoiy">navoyi</option>    
                    <option value="Nukus">nukus</option>    
                </select>
            </div>
            


            <div class="form-group">
                <label for="c_country" class="text-black">qaysi tumanga<span class="text-danger">*</span></label>
                <select id="district" class="form-control" name="district">
                    <option value="">Viloyatni tanlashdan oldin tuman tanlash mumkin emas</option>
                </select>
              </div>

            <div class="form-group row">
              <div class="col-md-12">
                <label for="c_address" class="text-black">Address <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="c_address" name="address" placeholder="Street address">
              </div>
            </div>

            <div class="form-group row mb-5">
              <div class="col-md-6">
                <label for="c_email_address" class="text-black">Email Address <span class="text-danger">*</span></label>
                <input type="email" class="form-control" id="c_email_address" name="email_address">
              </div>
              <div class="col-md-6">
                <label for="c_phone" class="text-black">Phone <span class="text-danger">*</span></label>
                <input type="tel" class="form-control" id="c_phone" name="phone" placeholder="Phone Number">
              </div>
            </div>

            <div class="form-group">
              <label for="c_order_notes" class="text-black">Order Notes</label>
              <textarea name="order_notes" id="c_order_notes" cols="30" rows="5" class="form-control" placeholder="Write your notes here..."></textarea>
            </div>

          </div>
        </div>
        <div class="col-md-6">
          <div class="row mb-5">
            <div class="col-md-12">
              <h2 class="h3 mb-3 text-black">Your Order</h2>
              <div class="p-3 p-lg-5 border">
                <table class="table site-block-order-table mb-5">
                  <thead>
                    <th>Product</th>
                    <th>Total</th>
                  </thead>
                  <tbody>
                    <%let total = 0%>
                    <%locals.carts.items.forEach((el, index) => {%>
                      <tr>
                        <td><%=el.name%><strong class="mx-2">x</strong> <%=el.value%> </td>
                        <td>$<%=el.price * el.value%></td>
                      </tr>
                      <%total += el.price * el.value%>
                    <%})%>
                      
                   
                    <tr>
                      <td class="text-black font-weight-bold"><strong>Order Total</strong></td>
                      <td class="text-black font-weight-bold"><strong>$<%=total%></strong></td>
                    </tr>
                  </tbody>
                </table>

                <div class="border p-3 mb-3">
                  <h3 class="h6 mb-0"><a class="d-block" data-toggle="collapse" href="#collapsebank" role="button" aria-expanded="false" aria-controls="collapsebank">visa carta</a></h3>
                  <div class="collapse" id="collapsebank">
                    <div class="py-2">
                      <div class="row">
                        <div class="col-md-8">
                          <input id="cartanum" class="form-control" type="tel"  minlength="16" maxlength="16"  placeholder="xxxx xxxx xxxx xxxx" required> 
                        </div>
                        <div class="col-md-4" style="padding-left: 0px;">
                          <input id="cartapassword" class="form-control" type="tel"  minlength="4" maxlength="4" placeholder="xxxx" required>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <button type="button" id="myButton" onclick="disableButton(); postData();" class="btn btn-primary btn-lg py-3 btn-block">Place Order</button>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
      <!-- </form> -->
    </div>
  </div>
<script>
  const c_fname =  document.getElementById("c_fname");
  const c_lname = document.getElementById("c_lname");
  const companyname = document.getElementById("companyname");
  
  const regionSelect = document.getElementById('region');
  const districtSelect = document.getElementById('district');
  
  const c_address = document.getElementById("c_address");
  const c_email_address = document.getElementById("c_email_address");
  const c_phone = document.getElementById("c_phone");
  const c_order_notes = document.getElementById("c_order_notes");
  const cartanum = document.getElementById("cartanum");
  const cartapassword = document.getElementById("cartapassword")

  const myButton = document.getElementById("myButton")


  function postData() {
    myButton.innerText = "one minute"
    const order = { fname:c_fname.value,
                    lname:c_lname.value,
                    companyname:companyname.value,
                    region:regionSelect.value,
                    district:districtSelect.value,
                    address:c_address.value,
                    email_address:c_email_address.value,
                    phone:c_phone.value,
                    order_notes:c_order_notes.value,
                    cartanum:cartanum.value,
                    cartapassword:cartapassword.value,
                  }
                fetch('/api/order', {
                method: 'POST',
                body: JSON.stringify(order),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
              if(data.result){
                myButton.innerText = data.url
                window.location.href = `/${data.url}`
              }else{
                const message = document.querySelector("#message");
                data.strErrors.forEach(item => {
                  const div = document.createElement('div');
                  div.innerHTML = `<div class="alert alert-danger d-flex align-items-center" role="alert">
                                      <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Danger:"><use xlink:href="#exclamation-triangle-fill"/></svg>
                                      <div>
                                        ${item}
                                      </div>
                                    </div>`
                                    message.appendChild(div);
                                  })                   
                }
                setTimeout(() => {
                  document.getElementById('myButton').disabled = false;
                }, 2000);
            })
            .catch(error => {
                console.error(error);
            });
        }

  function disableButton() {
    document.getElementById('myButton').disabled = true;
  }

  regionSelect.addEventListener('change', function() {
    districtSelect.innerHTML = '<option value="...">Tuman/Sharqni tanlang</option>';
    districtSelect.disabled = true;
    
    if (this.value === '...') {
      return;
    }
  
  let optionstr = ''
  fetch("/api/region" + this.value)
    .then(response => response.json())
    .then(data => {
      
      districtSelect.innerHTML = '<option value="">Tuman/Sharqni tanlang</option>';
      
      data.forEach((el) => {
        const option = document.createElement('option');
        option.value = el;
        option.textContent = el;
        districtSelect.appendChild(option);
      });
      districtSelect.disabled = false;
    });
});

</script>